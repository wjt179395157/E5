# .github/workflows/ci.yml
# è®°è´¦åº”ç”¨æŒç»­é›†æˆé…ç½®

name: Accounting App CI

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ä»»åŠ¡å®šä¹‰
jobs:
  # ============================================================
  # ä»»åŠ¡1: ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pylint
    
    - name: ğŸ” Run Flake8
      run: |
        # æ£€æŸ¥ä»£ç é£æ ¼ï¼ˆå¿½ç•¥æŸäº›è§„åˆ™ï¼‰
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: ğŸ¨ Check Code Formatting with Black
      run: |
        black --check --diff .
      continue-on-error: true
    
    - name: ğŸ“Š Run Pylint
      run: |
        pylint *.py --exit-zero
      continue-on-error: true

  # ============================================================
  # ä»»åŠ¡2: å•å…ƒæµ‹è¯•
  # ============================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality  # ä¾èµ–ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']  # å¤šç‰ˆæœ¬æµ‹è¯•
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ’¾ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ§ª Run Unit Tests with Coverage
      run: |
        pytest test_unit.py -v -s \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --html=report-unit.html \
          --self-contained-html
    
    - name: ğŸ“Š Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true
    
    - name: ğŸ“„ Upload Test Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-report-py${{ matrix.python-version }}
        path: |
          report-unit.html
          htmlcov/
        retention-days: 30

  # ============================================================
  # ä»»åŠ¡3: é›†æˆæµ‹è¯•
  # ============================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests  # ä¾èµ–å•å…ƒæµ‹è¯•å®Œæˆ
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”— Run Integration Tests
      run: |
        pytest test_integration.py -v -s \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --html=report-integration.html \
          --self-contained-html
    
    - name: ğŸ“„ Upload Integration Test Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-report
        path: |
          report-integration.html
          htmlcov/
        retention-days: 30

  # ============================================================
  # ä»»åŠ¡4: å®Œæ•´æµ‹è¯•å¥—ä»¶
  # ============================================================
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¯ Run All Tests
      run: |
        pytest test_unit.py test_integration.py -v -s \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term \
          --html=report-full.html \
          --self-contained-html
    
    - name: ğŸ“Š Generate Coverage Badge
      run: |
        pip install coverage-badge
        coverage-badge -o coverage.svg -f
      continue-on-error: true
    
    - name: ğŸ“„ Upload Full Test Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: full-test-report
        path: |
          report-full.html
          htmlcov/
          coverage.svg
        retention-days: 30
    
    - name: ğŸ’¬ Comment Test Results on PR
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const comment = `## ğŸ‰ æµ‹è¯•å®Œæˆï¼\n\nâœ… æ‰€æœ‰æµ‹è¯•å·²é€šè¿‡\n\næŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šè¯·ä¸‹è½½ Artifacts`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      continue-on-error: true

  # ============================================================
  # ä»»åŠ¡5: æ„å»ºæ£€æŸ¥
  # ============================================================
  build-check:
    name: Build & Import Check
    runs-on: ubuntu-latest
    needs: full-test-suite
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” Check Imports
      run: |
        python -c "import app; import models; import storage; print('âœ… All modules imported successfully')"
    
    - name: ğŸ—ï¸ Test Application Startup
      run: |
        python -c "from app import AccountingApp; app = AccountingApp(); print('âœ… Application can be instantiated')"
